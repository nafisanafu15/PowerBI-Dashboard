{% extends "global_layout.html" %}
{% block title %}Visa Status Breakdown{% endblock %}

{% block extra_head %}
  <!-- (Chart.js + Luxon should already be in global_layout.html; include here only if not) -->
  <!--
  <script src="https://cdn.jsdelivr.net/npm/luxon@3/build/global/luxon.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="report-main container-fluid">
  <div class="row g-3">
    <!-- Filters -->
    <aside class="filters-panel col-lg-2">
      <h3 class="mb-3">Filters</h3>

      <div class="filter-group mb-3 time-filter">
        <label class="form-label fw-bold">Time Period</label>
        <div class="radio-group d-flex flex-column">
          <label><input type="radio" name="time" value="today"> Today</label>
          <label><input type="radio" name="time" value="week"> This week</label>
          <label><input type="radio" name="time" value="month"> This month</label>
          <label><input type="radio" name="time" value="year"> This year</label>
          <label><input type="radio" name="time" value="custom"> Set up</label>
        </div>
        <div class="date-range mt-2" style="display:none;">
          <input type="text" class="time-range form-control form-control-sm" placeholder="Select range">
          <div class="mt-2 d-flex gap-2">
            <button type="button" class="btn btn-outline-primary btn-sm rounded-pill apply-range">Apply</button>
            <button type="button" class="btn btn-outline-secondary btn-sm rounded-pill cancel-range">Cancel</button>
          </div>
        </div>
      </div>

      <div class="filter-group mb-3">
        <label class="form-label fw-bold">Sort by</label>
        <div class="sort-buttons d-flex flex-wrap gap-2">
          <button class="btn btn-outline-primary btn-sm" data-sort="asc">Ascending</button>
          <button class="btn btn-outline-primary btn-sm" data-sort="desc">Descending</button>
        </div>
      </div>
    </aside>

    <!-- Main content -->
    <section class="report-content col-lg-8">
      <h1 class="mb-3 text-center">Visa Status Breakdown</h1>
      <h2 class="h5 text-muted mb-4">Visas by Type</h2>

      <canvas id="mainChart" class="mb-4" height="220"></canvas>

      <div class="table-responsive" style="display:none;">
        <table id="dataTable" class="table table-bordered table-sm">
          <thead class="table-light">
            <tr>
              <th>Visa Type</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Chart options -->
    <aside class="chart-options col-lg-2">
      <h3 class="mb-3">Graphs and Charts</h3>
      <div class="d-flex flex-column gap-2">
        <button class="btn btn-outline-primary chart-btn" data-type="bar"><i class="fa-solid fa-chart-column me-1"></i> Bar Chart</button>
        <button class="btn btn-outline-primary chart-btn active" data-type="doughnut"><i class="fa-solid fa-circle-notch me-1"></i> Donut Chart</button>
        <button class="btn btn-outline-primary chart-btn" data-type="pie"><i class="fa-solid fa-chart-pie me-1"></i> Pie Chart</button>
        <button class="btn btn-outline-primary chart-btn" data-type="table"><i class="fa-solid fa-table me-1"></i> Table</button>
      </div>
    </aside>
  </div>
</div>

<!-- Per-page config -->
<script>
  window.reportConfig = {
    endpoint: '/api/visa-breakdown',   // <- IMPORTANT API
    groupField: 'visa_type',           // accepts 'visa_status' too (handled in JS)
    columns: [
      { key: 'visa_type', label: 'Visa Type' },
      { key: 'total',     label: 'Total' }
    ],
    allowUnknown: true                 // don't drop rows if label is "Unknown"
  };
</script>
<script src="{{ url_for('static', filename='js/report.js') }}" defer></script>
{% endblock %}
